<!DOCTYPE html>
<html>
    <head>
        <title>
            Courses
        </title>
        <link rel="stylesheet" href="LMS.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@0.18.2/dist/web3.min.js"></script>
        <script>
		
            web3 = new Web3(new Web3.providers.HttpProvider("http://120.126.151.197:7777"));
            web3.eth.defaultAccount = web3.eth.accounts[0];
            var currentUrl = window.location.href;
            let params = (new URL(currentUrl)).searchParams;
            var id_Text=params.get('id')
            window.onload = function what(){
                document.getElementById("id").innerHTML = 'ID: '+ id_Text;
            };
            var infoContract = web3.eth.contract([
                {
                    "constant": false,
                    "inputs": [
                        {
                            "name": "_grad_year",
                            "type": "string"
                        },
                        {
                            "name": "_stud_id",
                            "type": "string"
                        },
                        {
                            "name": "_stud_name_zh",
                            "type": "string"
                        },
                        {
                            "name": "_stud_name_en",
                            "type": "string"
                        },
                        {
                            "name": "_course_zh",
                            "type": "string"
                        },
                        {
                            "name": "_course_en",
                            "type": "string"
                        }
                    ],
                    "name": "setInfo",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "getInfo",
                    "outputs": [
                        {
                            "name": "",
                            "type": "string"
                        },
                        {
                            "name": "",
                            "type": "string"
                        },
                        {
                            "name": "",
                            "type": "string"
                        },
                        {
                            "name": "",
                            "type": "string"
                        },
                        {
                            "name": "",
                            "type": "string"
                        },
                        {
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "name": "_grad_year",
                            "type": "string"
                        },
                        {
                            "name": "_stud_id",
                            "type": "string"
                        },
                        {
                            "name": "_stud_name_zh",
                            "type": "string"
                        },
                        {
                            "name": "_stud_name_en",
                            "type": "string"
                        },
                        {
                            "name": "_course_zh",
                            "type": "string"
                        },
                        {
                            "name": "_course_en",
                            "type": "string"
                        }
                    ],
                    "name": "change",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                }
            ]);
            function deploy()
            {
                $("#log").html('loading... deploy');
                const contractInstance = infoContract.new({
                    data: '0x60806040526040805190810160405280600481526020017f4e756c6c00000000000000000000000000000000000000000000000000000000815250600090805190602001906200005192919062000207565b506040805190810160405280600481526020017f4e756c6c00000000000000000000000000000000000000000000000000000000815250600190805190602001906200009f92919062000207565b506040805190810160405280600481526020017f4e756c6c0000000000000000000000000000000000000000000000000000000081525060029080519060200190620000ed92919062000207565b506040805190810160405280600481526020017f4e756c6c00000000000000000000000000000000000000000000000000000000815250600390805190602001906200013b92919062000207565b506040805190810160405280600481526020017f4e756c6c00000000000000000000000000000000000000000000000000000000815250600490805190602001906200018992919062000207565b506040805190810160405280600481526020017f4e756c6c0000000000000000000000000000000000000000000000000000000081525060059080519060200190620001d792919062000207565b506000600660146101000a81548160ff0219169083151502179055503480156200020057600080fd5b50620002b6565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200024a57805160ff19168380011785556200027b565b828001600101855582156200027b579182015b828111156200027a5782518255916020019190600101906200025d565b5b5090506200028a91906200028e565b5090565b620002b391905b80821115620002af57600081600090555060010162000295565b5090565b90565b610d3e80620002c66000396000f300608060405260043610610057576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806310658dae1461005c5780635a9b0b8914610223578063d1826842146104cf575b600080fd5b34801561006857600080fd5b50610221600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610696565b005b34801561022f57600080fd5b5061023861079b565b6040518080602001806020018060200180602001806020018060200187810387528d818151815260200191508051906020019080838360005b8381101561028c578082015181840152602081019050610271565b50505050905090810190601f1680156102b95780820380516001836020036101000a031916815260200191505b5087810386528c818151815260200191508051906020019080838360005b838110156102f25780820151818401526020810190506102d7565b50505050905090810190601f16801561031f5780820380516001836020036101000a031916815260200191505b5087810385528b818151815260200191508051906020019080838360005b8381101561035857808201518184015260208101905061033d565b50505050905090810190601f1680156103855780820380516001836020036101000a031916815260200191505b5087810384528a818151815260200191508051906020019080838360005b838110156103be5780820151818401526020810190506103a3565b50505050905090810190601f1680156103eb5780820380516001836020036101000a031916815260200191505b50878103835289818151815260200191508051906020019080838360005b83811015610424578082015181840152602081019050610409565b50505050905090810190601f1680156104515780820380516001836020036101000a031916815260200191505b50878103825288818151815260200191508051906020019080838360005b8381101561048a57808201518184015260208101905061046f565b50505050905090810190601f1680156104b75780820380516001836020036101000a031916815260200191505b509c5050505050505050505050505060405180910390f35b3480156104db57600080fd5b50610694600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610b6c565b005b600660149054906101000a900460ff1615156107935785600090805190602001906106c2929190610c6d565b5084600190805190602001906106d9929190610c6d565b5083600290805190602001906106f0929190610c6d565b508260039080519060200190610707929190610c6d565b50816004908051906020019061071e929190610c6d565b508060059080519060200190610735929190610c6d565b5033600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001600660146101000a81548160ff0219169083151502179055505b505050505050565b606080606080606080600060016002600360046005858054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108455780601f1061081a57610100808354040283529160200191610845565b820191906000526020600020905b81548152906001019060200180831161082857829003601f168201915b50505050509550848054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108e15780601f106108b6576101008083540402835291602001916108e1565b820191906000526020600020905b8154815290600101906020018083116108c457829003601f168201915b50505050509450838054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561097d5780601f106109525761010080835404028352916020019161097d565b820191906000526020600020905b81548152906001019060200180831161096057829003601f168201915b50505050509350828054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a195780601f106109ee57610100808354040283529160200191610a19565b820191906000526020600020905b8154815290600101906020018083116109fc57829003601f168201915b50505050509250818054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ab55780601f10610a8a57610100808354040283529160200191610ab5565b820191906000526020600020905b815481529060010190602001808311610a9857829003601f168201915b50505050509150808054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b515780601f10610b2657610100808354040283529160200191610b51565b820191906000526020600020905b815481529060010190602001808311610b3457829003601f168201915b50505050509050955095509550955095509550909192939495565b3373ffffffffffffffffffffffffffffffffffffffff16600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16148015610bd55750600660149054906101000a900460ff165b15610c65578560009080519060200190610bf0929190610c6d565b508460019080519060200190610c07929190610c6d565b508360029080519060200190610c1e929190610c6d565b508260039080519060200190610c35929190610c6d565b508160049080519060200190610c4c929190610c6d565b508060059080519060200190610c63929190610c6d565b505b505050505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610cae57805160ff1916838001178555610cdc565b82800160010185558215610cdc579182015b82811115610cdb578251825591602001919060010190610cc0565b5b509050610ce99190610ced565b5090565b610d0f91905b80821115610d0b576000816000905550600101610cf3565b5090565b905600a165627a7a72305820046b502dbe842e71d463de6fee9a21d09c3772022b13b4557e01a2875d46f5650029',
                    from: web3.eth.accounts[0],
                    gas: 300000*4
                }, (err, res) => {
                    if (err) {
                        console.log(err);
                        $("#log").html(err+' (deploy)');
                        document.getElementById("deploy_button").style.visibility = "visible";
                        return;
                    }
                    $("#log").html('loading... upload data');
                    setTimeout(function () {
                        UpdateFile(res.address);
                    }, 500);
                });
            }
            function UpdateFile(Contract_address) {
                var info = infoContract.at(Contract_address);
                info.setInfo($("#grad_year").val(), $("#stud_id").val(), $("#stud_name_zh").val(),$("#stud_name_en").val(), $("#course_zh").val(), $("#course_en").val(),
                    {
                        gas: 6000000,
                        from: web3.eth.accounts[0]
                    } ,function (error){
                        if (!error) {
                             $("#log").html('loading... upload complete');
                            if(Contract_address!=null) {
                                jQuery.ajax({
                                    type: "POST",
                                    url: "create_user.php?stud_id=" + $("#stud_id").val() + "&pw=" + $("#pw").val() + "&blockchain_code=" + Contract_address + "&type=user",
                                    success: function (data) {
                                    }
                                });
                                $("#log").html('complete');
                                //console.log("signup.php?stud_id="+$("#stud_id").val()+"&pw="+$("#pw").val()+"&blockchain_code="+Contract_address+"&type=user");
                                document.getElementById("deploy_button").style.visibility = "visible";
                            }
                        } else {
                            $("#log").html(error+' (UpdateFile)');
                            document.getElementById("deploy_button").style.visibility = "visible";
                            console.log(error);
                        }
                    });
            }
            function UnlockAccount()
            {
                document.getElementById("deploy_button").style.visibility = "hidden";
                $("#log").html('loading... Lock Account');
                web3.personal.unlockAccount(web3.eth.accounts[0], $("#passwd").val(), 30000,
                    function(error, result){
                        if(error) {
                            $("#log").html(error);
                            document.getElementById("deploy_button").style.visibility = "visible";
                            return;
                        }else {
                            deploy();
                        }
                    }
                );
            }
            function change() {
                window.location.href = 'LMS_admin_change.html?id=' + id_Text ;
            }
            function create_user() {
                window.location.href = 'LMS_admin_create_user.html?id=' + id_Text ;
            }
        </script>
    </head>
    <body>
        <main class="course-area">
            <div class="course-box">
                <nav class="user-nav">
                    <a href="LMS_login.html" class="back-link">&larr; Logout</a>
                    <div class="user-nav-user">
                        <img src="img/my.jpg" alt="my" class="user-nav-img">
                        <span class="user-nav-text" id="id"></span>
                    </div>

                </nav>
                <div class="main-content">
                    <nav class="side-bar" style="border:3px #cccccc solid;width:170px;height:1000px;">
                        <ul class="side-nav" style="width:170px;height:1000px;">
                            <li class="side-nav-item">
                                <a onclick="change()" class="side-nav-link">
                                    <i class="fa fa-info" aria-hidden="true"></i>
                                    <span class="side-nav-text">change</span>
                                </a>
                            </li>
                            <li class="side-nav-item">
                                <a onclick="create_user()" class="side-nav-link">
                                    <i class="fa fa-info" aria-hidden="true"></i>
                                    <span class="side-nav-text">create_user</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                <div style="width:1000px;height:1000px;border:3px #cccccc dashed;" class="video-content">
                <div class="PDF-content">
                    <h2 class="PDF_title">
                        Admin
                    </h2>
                    <center><table style="border:3px #cccccc solid;width:900px;height:700px;" cellpadding="10" border='1' >
                        <tr><td>
                            <center><h1>Upload Diploma</h1></center>
                            <br>
                            <center><label for="ip">grad year:</label>
                                <input type="text" id="grad_year" value="" size="70"></center>
                            <br>
                            <br>
                            <center><label for="ip">stud id:</label>
                                <input type="text" id="stud_id" value="" size="70"></center>
                            <br>
                            <br>
                            <center><label for="ip">stud name zh:</label>
                                <input type="text" id="stud_name_zh" value="" size="70"></center>
                            <br>
                            <br>
                            <center><label for="ip">stud name en:</label>
                                <input type="text" id="stud_name_en" value="" size="70"></center>
                            <br>
                            <br>
                            <center><label for="ip">course zh:</label>
                                <input type="text" id="course_zh" value="" size="70"></center>
                            <br>
                            <br>
                            <center><label for="ip">course en:</label>
                                <input type="text" id="course_en" value="" size="70"></center>
                            <br>
                            <br>
                            <center><label for="ip">pw:</label>
                                <input type="text" id="pw" value="" size="70"></center>
                            <br>
                            <br>
                            <center><label for="ip">Unlock Account Password:</label>
                                <input type="text" id="passwd" value="" size="70"></center>
                            <br>
                            <br>
                            <center><button id="deploy_button" onclick="UnlockAccount()">connection</button></center>
                            <br>
                            <br>
                            <h2 id="log"></h2>
                        </td></tr>
                    </table></center>
                    <br>
                </div>
            </div>
            </div>
        </main>
    </body>
</html>